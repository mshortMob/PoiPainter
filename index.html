<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">s
	<title>PoiPainter V1.7</title>
	<link rel="stylesheet" type="text/css">
	<style>
		.ui-draggable{
			background-color:grey;
			margin-top:-15px;
			margin-left:-15px;
			width:30px;
			height:30px;
			z-index:10000000;
		}
		body{
			background-color:black;
			padding:0px;
			margin:0px;
			top:0px;
			left:0px;
			height:100%;
			width:100%;
		}
		img{
			left:10%;
			top:10%;
			float:left;
			position: absolute;
			transition: opacity .1s;
		}
	</style>
</head>
<body id="body">
	<canvas id="canvasp8" autoplay style="display:none;"></canvas>
	<canvas id="dmx_canvas" autoplay style="d;"></canvas>
	<script src="jquery-1.12.3.js"></script>
	<script src="numeric.min.js"> </script>
	<script src="jquery-ui.min.js"> </script>
	<script src='dat.gui.min.js'></script>
	<script src="pixel8.js"></script>
	<script src="gifler.min.js"></script>
	<script>
		initGlobalVars()
		function initGlobalVars(){
			displayObjectsArray = [];
			currentObject = "";
			dmxInterval=0;
			addControls();
			setTimeout(function(){initializeDMX();},3000);
			gfo=gifler('anim3.gif').animate(document.getElementById('dmx_canvas'));
		}

		var displayObject = function(id, classNumber, image, zindex,isCurrent){
			this.id=id;
			this.classNumber =classNumber;
			this.image=mappingController.Image;
			this.zindex=mappingController.ZValue;
			this.isCurrent=isCurrent;
			this.updateImage = function(){
				this.image=mappingController.Image;
				document.getElementById(this.id).src="anim"+(this.image+1)+".gif";
			}
			this.updateZvalue = function(){
				this.zindex=mappingController.ZValue;
				document.getElementById(this.id).style.zIndex=this.zindex;
			}
			this.setCurrent = function (){
				currentObject=this.id
				updateControlsView();
				var handlesSet = document.getElementsByClassName(this.classNumber)
				for(var x=0; x<handlesSet.length; x++){
					handlesSet[x].style.display='inline'
				}
				this.isCurrent=true;
			}
			this.setNotCurrent = function (){
				var handlesSet = document.getElementsByClassName(this.classNumber)
				for(var x=0; x<handlesSet.length; x++){
					handlesSet[x].style.display='none'
				}
				this.isCurrent=false;
			}
			this.init = function () {
				for(var x=0; x<displayObjectsArray.length;x++){
					var handlesSet = document.getElementsByClassName('handlesSet'+x)
					for(var x=0; x<handlesSet.length; x++){
							handlesSet[x].style.display='none'
					}
				}
				var node = document.createElement("img");
				node.setAttribute("Id",this.id)
				node.setAttribute("class","displayCanvas")
				node.setAttribute("onclick",'selectObject(this.id)')
				node.src="anim1.gif"
				node.width=640;
				node.height=360;
				node.autoplay=true;
				node.loop=true;
				document.body.appendChild(node);
				makeTransformable("#"+ this.id)
				selectObject(this.id);
				this.updateImage();
				this.updateZvalue();
			}
			this.init();
		}

		function addControls(){
				mappingController  = {
					ZValue:0,
					Image:0
				};
				utilsController={
					SendDMX:false,
					DMX_Rate: 50,
					DMX_Image: 1
				};
				gui = new dat.GUI();
				gui.width=260;
				globalFolder=gui.addFolder( "Global" )
				globalFolder.open();
				globalFolder.add({ 'Add Object':function(){ addObject(); }},'Add Object');
				globalFolder.add({ 'Remove Object':function(){ removeCurrentObject(); }},'Remove Object');
				controlsFolder=gui.addFolder( "MappingControls" )
				controlsFolder.open();
				controlsFolder.add( mappingController, "ZValue", -20, 20, 1 ).onChange(function(){mappingController.ZValue=parseInt(mappingController.ZValue); displayObjectsArray[currentObject].updateZvalue();});
				controlsFolder.add( mappingController, "Image", 0, 8, 1 ).onChange(function(){mappingController.Image=parseInt(mappingController.Image);displayObjectsArray[currentObject].updateImage();});
				utilsFolder=gui.addFolder( "Utils" )
				utilsFolder.open();
				utilsFolder.add({ 'Full Screen':function(){ requestFullScreen() }},'Full Screen');
				utilsFolder.add( utilsController, "SendDMX", true ).onChange(function(){ toggleDmxSend(); });	
				utilsFolder.add( utilsController, "DMX_Rate", 25, 250, 1 ).onChange(function(){utilsController.DMX_Rate=parseInt(utilsController.DMX_Rate);toggleDmxSend();});
				utilsFolder.add( utilsController, "DMX_Image", 1, 9, 1 ).onChange(function(){utilsController.DMX_Image=parseInt(utilsController.DMX_Image);changeDMXImage("anim"+utilsController.DMX_Image+".gif");});
			}

		function updateControlsView(){
			mappingController.Image=displayObjectsArray[currentObject].image;
			mappingController.ZValue=displayObjectsArray[currentObject].zindex;
			for (var i in gui.__folders.MappingControls.__controllers) {
				gui.__folders.MappingControls.__controllers[i].updateDisplay();
			}
		}
		
		function addObject(){
			displayObjectsArray.push(new displayObject(displayObjectsArray.length, 'handlesSet'+displayObjectsArray.length, "1", true))
		}

		function removeCurrentObject(){
			document.getElementById(currentObject).style.display='none';
			selectObject(currentObject)
		}

		function selectObject(id){
			for(var x=0;x<displayObjectsArray.length;x++){
				if (x==id) {
					if (displayObjectsArray[x].isCurrent==true) {
							displayObjectsArray[id].setNotCurrent(); 
					}else{
							displayObjectsArray[id].setCurrent(); 
					} 
				}else{
					displayObjectsArray[x].setNotCurrent();    
				}  
			}
			currentObject=id;
		}

		function changeCurrentImage(){
			if (displayObjectsArray[currentObject].isCurrent) {
				displayObjectsArray[currentObject].updateImage();
			}
		}

		function requestFullScreen() {
			// Supports most browsers and their versions.
			var element = document.body; // Make the body go full screen.
			var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;

			if (requestMethod) { // Native full screen.
				requestMethod.call(element);
			} else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
				var wscript = new ActiveXObject("WScript.Shell");
				if (wscript !== null) {
					wscript.SendKeys("{F11}");
				}
			}
		}

		function changeDMXImage(gifFilePath){
			dmx_canvas=document.getElementById('dmx_canvas');
			document.body.removeChild(dmx_canvas)
			dmx_canvas = document.createElement("canvas");
			dmx_canvas.id="dmx_canvas";
			document.body.appendChild(dmx_canvas)
			gfo=gifler(gifFilePath).animate(dmx_canvas);
		}
		
		function getPixelData(){
			pixelDataString="";
			if(displayObjectsArray.length>=0){
				dmx_canvas=document.getElementById("dmx_canvas");
				var data = pixel8(dmx_canvas,0,0,dmx_canvas.width,dmx_canvas.height);
				var width=dmx_canvas.width;
				var height=dmx_canvas.height;
				var numPixels=28
				for(i=0;i<numPixels;i++){
					var rv=data.pixelAt(parseInt(width/numPixels*i+width/(numPixels*2)),height/2)["red"];
					var gv=data.pixelAt(parseInt(width/numPixels*i+width/(numPixels*2)),height/2)["green"];
					var bv=data.pixelAt(parseInt(width/numPixels*i+width/(numPixels*2)),height/2)["blue"];
					pixelThreshold=70;
					if( (rv+gv+bv)< pixelThreshold){
						rv=0;
						gv=0;
						bv=0;
					}
					if(rv<pixelThreshold){
						rv=rv/3.3;
					}
					if(gv<pixelThreshold){
						gv=gv/3.3;
					}
					if(bv<pixelThreshold){
						bv=bv/3.3;
					}

					rv=parseInt(rv);
					gv=parseInt(gv);
					bv=parseInt(bv);
					pixelDataString=pixelDataString+rv+","+gv+","+bv+",";
				}
			}
			return pixelDataString;
		}

		function toggleDmxSend(){
			if(utilsController.SendDMX==true){
				clearInterval(dmxInterval);
				dmxInterval=setInterval(writeDMX,utilsController.DMX_Rate);
			}else{
				clearInterval(dmxInterval);
			}
		}
	
		function writeDMX() {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					console.log("Send DMX: "+this.responseText);
				}
			};
			xhttp.open("POST","proxy/set_dmx", true);
			xhttp.setRequestHeader("accept", "*/*");
			xhttp.setRequestHeader("accept-language", "en-US,en;q=0.9,und;q=0.8");
			xhttp.setRequestHeader("cache-control", "no-cache");
			xhttp.setRequestHeader("content-type", "application/x-www-form-urlencoded;charset=UTF-8");
			xhttp.setRequestHeader("pragma", "no-cache" );
			xhttp.send("u=0&d="+getPixelData()+"0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0");
		}	

		function initializeDMX() {
			xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					console.log("Initialize DMX: "+this.responseText);
				}
			};
			xhttp.open("GET","proxy/reload", true);
			xhttp.send();
		}
		
		initStretcher();
		function initStretcher() {
		(function() {
		var $, applyTransform, getTransform, makeTransformable;
		$ = jQuery;
		getTransform = function(from, to) {
			var A, H, b, h, i, k_i, lhs, rhs, _i, _j, _k, _ref;
			console.assert((from.length === (_ref = to.length) && _ref === 4));
			A = [];
			for (i = _i = 0; _i < 4; i = ++_i) {
			A.push([from[i].x, from[i].y, 1, 0, 0, 0, -from[i].x * to[i].x, -from[i].y * to[i].x]);
			A.push([0, 0, 0, from[i].x, from[i].y, 1, -from[i].x * to[i].y, -from[i].y * to[i].y]);
			}
			b = [];
			for (i = _j = 0; _j < 4; i = ++_j) {
			b.push(to[i].x);
			b.push(to[i].y);
			}
			h = numeric.solve(A, b);
			H = [[h[0], h[1], 0, h[2]], [h[3], h[4], 0, h[5]], [0, 0, 1, 0], [h[6], h[7], 0, 1]];
			for (i = _k = 0; _k < 4; i = ++_k) {
			lhs = numeric.dot(H, [from[i].x, from[i].y, 0, 1]);
			k_i = lhs[3];
			rhs = numeric.dot(k_i, [to[i].x, to[i].y, 0, 1]);
			console.assert(numeric.norm2(numeric.sub(lhs, rhs)) < 1e-9, "Not equal:", lhs, rhs);
			}
			return H;
		};
		applyTransform = function(element, originalPos, targetPos, callback) {
			var H, from, i, j, p, to;
			from = (function() {
			var _i, _len, _results;
			_results = [];
			for (_i = 0, _len = originalPos.length; _i < _len; _i++) {
				p = originalPos[_i];
				_results.push({
				x: (p[0] - originalPos[0][0])-15,
				y: (p[1] - originalPos[0][1])-15
				});
			}
			return _results;
			})();
			to = (function() {
			var _i, _len, _results;
			_results = [];
			for (_i = 0, _len = targetPos.length; _i < _len; _i++) {
				p = targetPos[_i];
				_results.push({
				x: p[0] - originalPos[0][0],
				y: p[1] - originalPos[0][1]
				});
			}
			return _results;
			})();
			H = getTransform(from, to);
			$(element).css({
			'transform': "matrix3d(" + (((function() {
				var _i, _results;
				_results = [];
				for (i = _i = 0; _i < 4; i = ++_i) {
				_results.push((function() {
					var _j, _results1;
					_results1 = [];
					for (j = _j = 0; _j < 4; j = ++_j) {
					_results1.push(H[j][i].toFixed(20));
					}
					return _results1;
				})());
				}
				return _results;
			})()).join(',')) + ")",
			'transform-origin': '0 0'
			});
			return typeof callback === "function" ? callback(element, H) : void 0;
		};
		classCount=0;
		makeTransformable = function(selector, callback) {
			return $(selector).each(function(i, element) {
			var controlPoints, originalPos, p, position;
			$(element).css('transform', '');
			controlPoints = (function() {
				var _i, _len, _ref, _results;
				_ref = ['left top', 'left bottom', 'right top', 'right bottom'];
				_results = [];
				for (_i = 0, _len = _ref.length; _i < _len; _i++) {
				position = _ref[_i];
				_results.push($('<div class=handlesSet'+classCount+'>').css({
					border: '3px solid darkgrey',
					borderRadius: '8px',
					cursor: 'move',
					position: 'absolute',
					zIndex: 100000
				}).appendTo('body').position({
					at: position,
					of: element,
					collision: 'none'
				}));
				}
				classCount=classCount+1;
				return _results;
			})();
			originalPos = (function() {
				var _i, _len, _results;
				_results = [];
				for (_i = 0, _len = controlPoints.length; _i < _len; _i++) {
				p = controlPoints[_i];
				_results.push([p.offset().left, p.offset().top]);
				}
				return _results;
			})();
			$(controlPoints).draggable({
				start: (function(_this) {
				return function() {
					return $(element).css('pointer-events', 'none');
				};
				})(this),
				drag: (function(_this) {
				return function() {
					return applyTransform(element, originalPos, (function() {
					var _i, _len, _results;
					_results = [];
					for (_i = 0, _len = controlPoints.length; _i < _len; _i++) {
						p = controlPoints[_i];
						_results.push([p.offset().left, p.offset().top]);
					}
					return _results;
					})(), callback);
				};
				})(this),
				stop: (function(_this) {
				return function() {
					applyTransform(element, originalPos, (function() {
					var _i, _len, _results;
					_results = [];
					for (_i = 0, _len = controlPoints.length; _i < _len; _i++) {
						p = controlPoints[_i];
						_results.push([p.offset().left, p.offset().top]);
					}
					return _results;
					})(), callback);
					return $(element).css('pointer-events', 'auto');
				};
				})(this)
			});
			return element;
			});
		};
		window.makeTransformable = makeTransformable
		}).call(this);
		}
	</script>
</body>
</html>