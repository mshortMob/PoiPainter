<html>
	<head>
		<title>FlowMapper</title>
		<style>
			body{
			    margin:0px;
				background-color:black;
				padding:0%;
			}	
			.slider {
				-webkit-appearance: none;
				width: 97%;
				height: 33%;
				background: #d3d3d3;
				outline: none;
				opacity: 0.7;
				-webkit-transition: .2s;
				transition: opacity .2s;
				position:relative;
				display: block;
				margin-top:2%;
				transform:rotate(0deg);
				position:absolute;
				border-width: 2.5px;
				border-style: solid;
			}
			#speedSlider{
				top:33%;
				transform:scale(-1,1);
			}
			#brightnessSlider{
				top:66%;
			}
			.slider:hover {
			opacity: 1;
			}
			.slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			width: 50px;
			height: 100%;
			background: #354285;
			cursor: pointer;
			}
		</style>
	</head>
	<body>

		<input type="range" min="1" max="6" value="1" class="slider" id="presetSlider">
		<input type="range" min="10" max="400" value="125" class="slider" id="speedSlider" oninput="setSpeed();">
		<input type="range" min="0" max="1000" value="400" class="slider" id="brightnessSlider" oninput="setSpeed();">

		<script src="dependancies/dat.gui.min.js"></script>
		<script>

			init();
			function init(){
				dmxInterval=-1;
				setTimeout(function(){initializeDMX();},1000);
				patternsArray=[];
				getPatternData(1,patternsArray);
				masterIndex=0;
			}

			function getPatternData(patNum,patternsArray){
				var patternData=[];
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET", "../php/read.php?fn=pixelPatterns/datout"+patNum+".txt", true);
				xmlhttp.send();
				xmlhttp.onload = function(e){
                    var patternDataString=xmlhttp.response;
					var patternDataStringArray=patternDataString.split('\n');
					for(var x=0; x<patternDataStringArray.length-1; x++){
						var temp=patternDataStringArray[x].split(',');
						for(var y=0; y<temp.length; y++){
							temp[y]=parseInt(temp[y]);
						}
						patternData.push(temp);
					}
					patternsArray.push(patternData);
					if(patNum<6){
						getPatternData(patNum+1,patternsArray);
					}else{
						setSpeed();
					}
				}
			}
			
			function setSpeed(){
				clearInterval(dmxInterval);
				dmxInterval=setInterval(function(){
						masterIndex=(masterIndex+1)%patternsArray[document.getElementById("presetSlider").value-1].length;
						writeDMX();
				},parseInt(document.getElementById("speedSlider").value));
			}

			function writeDMX() {
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						console.log("Send DMX: "+this.responseText);
					}
				};
				xhttp.open("POST","proxy/set_dmx", true);
				xhttp.setRequestHeader("accept", "*/*");
				xhttp.setRequestHeader("accept-language", "en-US,en;q=0.9,und;q=0.8");
				xhttp.setRequestHeader("cache-control", "no-cache");
				xhttp.setRequestHeader("content-type", "application/x-www-form-urlencoded;charset=UTF-8");
				xhttp.setRequestHeader("pragma", "no-cache" );
				var volAdjustedData=patternsArray[document.getElementById("presetSlider").value-1][masterIndex];
				for(var x=0; x<patternsArray[document.getElementById("presetSlider").value-1][masterIndex].length ; x++){
					volAdjustedData[x]=parseInt(volAdjustedData[x]*document.getElementById("brightnessSlider").value/1000);
				}
				dmxPayloadString="u=0&d="+volAdjustedData.toString()+"0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0";
				// console.log(dmxPayloadString);
				xhttp.send(dmxPayloadString);
			}	

			function initializeDMX() {
				xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						console.log("Initialize DMX: "+this.responseText);
					}else{
						console.log("DMX Not Available");
					}
				};
				xhttp.open("GET","proxy/reload", true);
				xhttp.send();
			}
		
		</script>
	</body>
</html>

