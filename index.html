<html>
	<head>
		<title>FlowMapper</title>
		<style>
			body{
			    margin:0px;
				padding:0px;
				background-color:black;
			}	
			canvas{
				width:15.5%;
				height:97.5%;
				border-color:grey;
				border-width:thick;
				border-style: solid;
				margin:0px;
				position:absolute;
				top:0px;
			}
			#slider1{
				left:0%;
			}
			#slider2{
				left:16%;
			}
			#slider3{
				left:32%;
			}
			#slider4{
				left:48%;
			}
			#label1{
				color:grey;
				position:absolute;
				z-index: 3;
				user-select: none;
				transform: rotate(-90deg);
				font-size:1.25em;
				left:0%;
				bottom:21%;
			}
			#label2{
				color:grey;
				position:absolute;
				z-index: 3;
				user-select: none;
				transform: rotate(-90deg);
				font-size:1.25em;
				left:11%;
				bottom:27%;
			}
			#label3{
				color:grey;
				position:absolute;
				z-index: 3;
				user-select: none;
				transform: rotate(-90deg);
				font-size:1.25em;
				left:30%;
				bottom:23%;
			}
			#label4{
				color:grey;
				position:absolute;
				z-index: 3;
				user-select: none;
				transform: rotate(-90deg);
				font-size:1.25em;
				left:41.5%;
				bottom:29%;
			}
			#label5{
				color:grey;
				position:absolute;
				z-index: 3;
				user-select: none;
				font-size:1.25em;
				top:2.5%;
				right:7%;
			}
			#label6{
				color:grey;
				position:absolute;
				z-index: 3;
				user-select: none;
				font-size:1.25em;
				top:52.5%;
				right:7%;
			}
			#xy1{
				width:33%;
				height:48%;
				border-color:grey;
				border-width:thick;
				border-style: solid;
				margin:0px;
				position:absolute;
				top:0%;
				left:64%;
			}
			#xy2{
				width:33%;
				height:48%;
				border-color:grey;
				border-width:thick;
				border-style: solid;
				margin:0px;
				position:absolute;
				top:49%;
				left:64%;
			}
		</style>
	</head>
	<body>
		<div id="label1">Color Speed</div>
		<div id="label2">Color Range</div>
		<div id="label3">Init Color</div>
		<div id="label4">Mover Brightness</div>
		<div id="label5">Mover XY1</div>
		<div id="label6">Mover XY2</div>
		<canvas id="slider1" onmousedown="drawSliderPosition(this.id, 1-(this.offsetY/this.clientHeight) );"  ></canvas>
		<canvas id="slider2" onmousedown="drawSliderPosition(this.id, 1-(this.offsetY/this.clientHeight) );"  ></canvas>
		<canvas id="slider3" onmousedown="drawSliderPosition(this.id, 1-(this.offsetY/this.clientHeight) );"  ></canvas>
		<canvas id="slider4" onmousedown="drawSliderPosition(this.id, 1-(this.offsetY/this.clientHeight) );"  ></canvas>
		<canvas id="xy1" onmousedown="drawSliderPosition(this.id, 0, event.offsetX, event.offsetY);"  ></canvas>
		<canvas id="xy2" onmousedown="drawSliderPosition(this.id, 0, event.offsetX, event.offsetY);"  ></canvas>
	</body>
	<script>

		moverPatterns=[[000,000,000,000,000,000,000,000,000,000,000,000],
					   [255,000,000,255,000,000,255,000,000,255,000,000],
					   [000,255,000,000,255,000,000,255,000,000,255,000],
					   [255,000,255,000,000,255,255,000,255,000,000,255],
					   [000,000,255,000,000,255,000,000,255,000,000,255],
					   [000,000,255,000,255,000,000,000,255,000,255,000],
					   [000,255,255,000,255,000,000,255,255,000,255,000],
					   [255,000,000,000,000,255,255,000,000,000,000,255],
					   [000,255,000,000,000,000,000,255,000,000,000,000],
					   [000,000,000,000,255,000,000,000,000,000,255,000],
					   [255,100,000,000,000,000,255,100,000,000,000,000],
					   [000,000,000,255,000,255,000,000,000,255,000,255],
					   [000,000,000,000,000,000,000,000,000,255,255,255],
					   [000,000,000,000,000,000,255,255,255,000,000,000],
					   [000,000,000,255,255,255,000,000,000,000,000,000],
					   [255,255,255,000,000,000,000,000,000,000,000,000]];

		fxPatterns=moverPatterns;
		sliderValues={"slider1":0,"slider2":0,"slider3":0,"slider4":0};
		xyValues={"xy1":{"x":0,"y":0}, "xy2":{"x":0,"y":0} };
		fxXyValues=xyValues;
		mouseButtonState=0;

		function drawSliderPosition(sliderId, percentToFill, xyx, xyy){
			if(mouseButtonState==1){
				if(sliderId.indexOf("slider")!=-1){
					var c = document.getElementById(sliderId);
					var ctx = c.getContext("2d");
					ctx.clearRect(0, 0, c.width, c.height);
					ctx.beginPath();
					ctx.fillStyle = "lightgrey";
					ctx.rect(0, c.height-c.height*percentToFill, c.width, c.height*percentToFill);
					ctx.fill();
					sliderValues[sliderId]=parseInt(255*percentToFill);
					if(sliderValues[sliderId]<30){
						sliderValues[sliderId]=0;
					}
					if(sliderId=="slider2"){
						if(sliderValues[sliderId]>240){
							sliderValues["slider2"]=255;
						}else if(sliderValues[sliderId]<30){
							sliderValues["slider2"]=0;
						}else{
							sliderValues["slider2"]=.5*sliderValues["slider2"];
						}
					}
					writeDMX();
				}
				if(sliderId.indexOf("xy")!=-1){
					var c = document.getElementById(sliderId);
					var ctx = c.getContext("2d");
					ctx.clearRect(0, 0, c.width, c.height);
					ctx.beginPath();
					ctx.fillStyle = "lightgrey";
					ctx.arc(xyx/c.clientWidth*c.width, xyy/c.clientHeight*c.height, 10, 0, 2 * Math.PI);
					ctx.fill();
					xyValues[sliderId]["x"]=parseInt(xyx/c.clientWidth*255);
					xyValues[sliderId]["y"]=parseInt(xyy/c.clientHeight*255);
					writeDMX();
				}
			}
			if(sliderValues["slider2"]>255){
				sliderValues["slider2"]=255;
			}
			if(sliderValues["slider4"]>255){
				sliderValues["slider4"]=255;
			}
		}

		document.onmousemove=function(mouseevent){
			if(mouseevent.target.id.indexOf("slider")!=-1){
				drawSliderPosition(mouseevent.target.id, 1-(mouseevent.offsetY/document.getElementById(mouseevent.target.id).clientHeight) );
			}
			if(mouseevent.target.id.indexOf("xy")!=-1){
				drawSliderPosition(mouseevent.target.id, 0, mouseevent.offsetX, mouseevent.offsetY);
			}
		}

		document.onmousedown=function(mouseevent){
			mouseButtonState=1;
			if(mouseevent.target.id.indexOf("slider")!=-1){
				drawSliderPosition(mouseevent.target.id, 1-(mouseevent.offsetY/document.getElementById(mouseevent.target.id).clientHeight) );
			}
			if(mouseevent.target.id.indexOf("xy")!=-1){
				drawSliderPosition(mouseevent.target.id, 0, mouseevent.offsetX, mouseevent.offsetY);
			}
		}

		document.onmouseup=function(mouseevent){
			mouseButtonState=0;
		}

		function writeDMX() {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					console.log("Send DMX: "+this.responseText);
				}
			};
			xhttp.open("POST","proxy/set_dmx", true);
            xhttp.setRequestHeader("accept", "*/*");
            xhttp.setRequestHeader("accept-language", "en-US,en;q=0.9,und;q=0.8");
            xhttp.setRequestHeader("cache-control", "no-cache");
            xhttp.setRequestHeader("content-type", "application/x-www-form-urlencoded;charset=UTF-8");
            xhttp.setRequestHeader("pragma", "no-cache" );
			outString="u=3&d="+fxXyValues["xy1"]["x"]+",0,"+fxXyValues["xy1"]["y"]+",0,0,0,"+sliderValues["slider4"]+",0,"+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][0]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][1]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][2]+",0,"+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][3]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][4]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][5]+",0,0,0,0,0,0,"+fxXyValues["xy2"]["x"]+",0,"+fxXyValues["xy2"]["y"]+",0,0,0,"+sliderValues["slider4"]+",0,"+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][6]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][7]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][8]+",0,"+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][9]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][10]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][11]+",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0";
			// console.log(outString)
			xhttp.send(outString);
			// xhttp.send("u=3&d="+fxXyValues["xy1"]["x"]+",0,"+fxXyValues["xy1"]["y"]+",0,0,0,"+sliderValues["slider4"]+",0,"+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][0]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][1]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][2]+",0,"+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][3]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][4]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][5]+",0,0,0,0,0,0,"+fxXyValues["xy2"]["x"]+",0,"+fxXyValues["xy2"]["y"]+",0,0,0,"+sliderValues["slider4"]+",0,"+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][6]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][7]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][8]+",0,"+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][9]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][10]+","+fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))][11]+",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0");
		}

		function initializeDMX() {
			xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					console.log("Initialize DMX: "+this.responseText);
				}
			};
			xhttp.open("GET","proxy/reload", true);
			xhttp.send();
		}
		setTimeout(function(){initializeDMX();setInterval(writeDMX,100);},1000);
		
		setInterval(cycleTimer,50);
		cycleCount=0.0;
		function cycleTimer(){
			fxPatterns=moverPatterns;
			cycleCount=(cycleCount+(6*sliderValues["slider1"]/255))%(parseInt(moverPatterns.length*(sliderValues["slider2"]+30)/255));
			// console.log(parseInt(cycleCount));
			fxPatterns[parseInt((sliderValues["slider3"]/255)*(fxPatterns.length-1))]=moverPatterns[parseInt(((sliderValues["slider3"]/255)*(fxPatterns.length-1))+parseInt(cycleCount))%fxPatterns.length];
		}
	</script>
</html>
