<html>
	<head>
		<title>FlowMapper</title>
		<style>
			body{
			    margin:0px;
				background-color:black;
			}	
			canvas{
				opacity: 1;
				width:100%;
				height:100%;
				top:0px;
				left:0px;
				z-index:10;
				transform:scale(1,1);
				position:fixed;
				float:left;
				object-fit:fill;
				/* cursor: none; */
			}
			textarea{
				z-index:100;
				position:fixed;
				height:42.5%;
				width:35%;
				background-color: grey;
				border-color: #515151;
				border-width:4;
				border-top-width:8;
				border-left-width:8;
				border-right-width:8;
				font-size: 14px;
				wrap: off;
				white-space: nowrap;
			}
			#show_shader_editor{
				z-index:100;
				position:fixed;
				left:0px;
				top:0px;
				height:6%;
				width:100px;
				background-color: darkgrey;
				border-color: #515151;
				border-width:4;
				border-top-width:0;
				border-left-width:0;
				font-size: 14px;
			}
			#hide_shader_editor{
				z-index:100;
				position:fixed;
				left:0px;
				bottom:0px;
				height:15%;
				width:10%;
				background-color: darkgrey;
				border-color: #515151;
				border-width:4;
				border-left-width:8;
				border-bottom-width:8;
				font-size: 18px;
			}
			#update_shader_button{
				z-index:100;
				position:fixed;
				left:10%;
				bottom:0px;
				height:15%;
				width:25%;
				background-color: darkgrey;
				border-color: #515151;
				border-width:4;
				border-right-width:8;
				border-bottom-width:8;
				font-size: 24px;
			}
			#update_shader_button:active{
				background-color: grey;			
			}
			video{
				opacity: 1;
				width:100%;
				height:100%;
				top:0px;
				left:0px;
				z-index:-1;
				transform:scale(-1,1);
				position:fixed;
				float:left;
				object-fit:fill;
			}
		</style>
	</head>
	<body>
		<script src="dependancies/dat.gui.min.js"></script>
		<script>
		
			// dmxInterval=setInterval(writeDMX,100);

			patternData=[];
			getPatternData();
			function getPatternData(){
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET", "../php/read.php?fn=datout.txt", true);
				xmlhttp.send();
				xmlhttp.onload = function(e){
                    patternDataString=xmlhttp.response;
					patternDataStringArray=patternDataString.split('\t');
				for(var x=0; x<patternDataStringArray.length; x++){
					patternData[x]=parseInt(patternDataStringArray[x]);
				}
				}
			}
			
			function retrievePixelPattern(){
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET", "php/read.php?fn=dmxPresets/pixelPattern"+globalController.DMX_Preset+".txt", true);
				xmlhttp.send();
				xmlhttp.onload = function(e){
					var response=xmlhttp.response;
					var presetScenes=response.split('\n')
					var fullPresetArray=[];
					for(var s=0;s<presetScenes.length;s++){
						var stringArray=presetScenes[s].split(',');
						for(var t=0; t<stringArray.length;t++){
							stringArray[t]=parseInt(stringArray[t]);
						}
					fullPresetArray.push(stringArray);
					}
					dmxPresetData=fullPresetArray;
					//console.log(dmxPresetData);
				}
			}	

			function writeDMX() {
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						console.log("Send DMX: "+this.responseText);
					}
				};
				xhttp.open("POST","proxy/set_dmx", true);
				xhttp.setRequestHeader("accept", "*/*");
				xhttp.setRequestHeader("accept-language", "en-US,en;q=0.9,und;q=0.8");
				xhttp.setRequestHeader("cache-control", "no-cache");
				xhttp.setRequestHeader("content-type", "application/x-www-form-urlencoded;charset=UTF-8");
				xhttp.setRequestHeader("pragma", "no-cache" );
				// dmxPayloadString="u="+parseInt(globalController.Universe)+"&d="+getPixelData();
				// console.log(dmxPayloadString);

				var temp=getMoverData()
				temp=temp.substring(0,temp.length-1).split(",");
				moverString=""
				//m1
				moverString=moverString+parseInt(globalController.DMX_X1)+",";
				moverString=moverString+"0,";
				moverString=moverString+parseInt(globalController.DMX_Y1)+",";
				moverString=moverString+"0,0,0,";
				moverString=moverString+parseInt(255*globalController.Pixel_Level)+",";
				moverString=moverString+"0,";
				moverString=moverString+parseInt(temp[0])+",";
				moverString=moverString+parseInt(temp[1])+",";
				moverString=moverString+parseInt(temp[2])+",";
				moverString=moverString+"0,";
				moverString=moverString+parseInt(temp[3])+",";
				moverString=moverString+parseInt(temp[4])+",";
				moverString=moverString+parseInt(temp[5])+",0,0,0,0,0,0,";

				//m2
				moverString=moverString+parseInt(globalController.DMX_X2)+",";
				moverString=moverString+"0,";
				moverString=moverString+parseInt(globalController.DMX_Y2)+",";
				moverString=moverString+"0,0,0,";
				moverString=moverString+parseInt(255*globalController.Pixel_Level)+",";
				moverString=moverString+"0,";
				moverString=moverString+parseInt(temp[0])+",";
				moverString=moverString+parseInt(temp[1])+",";
				moverString=moverString+parseInt(temp[2])+",";
				moverString=moverString+"0,";
				moverString=moverString+parseInt(temp[3])+",";
				moverString=moverString+parseInt(temp[4])+",";
				moverString=moverString+parseInt(temp[5])+",0,0,0,0,0,0,";

				//pix
				moverString=moverString+parseInt(temp[6]/10)+",";
				moverString=moverString+parseInt(temp[7]/10)+",";
				moverString=moverString+parseInt(temp[8]/10)+",";
				moverString=moverString+parseInt(temp[9]/10)+",";
				moverString=moverString+parseInt(temp[10]/10)+",";
				moverString=moverString+parseInt(temp[11]/10)+",";
				moverString=moverString+parseInt(temp[6]/10)+",";
				moverString=moverString+parseInt(temp[7]/10)+",";
				moverString=moverString+parseInt(temp[8]/10)+",";
				moverString=moverString+parseInt(temp[9]/10)+",";
				moverString=moverString+parseInt(temp[10]/10)+",";
				moverString=moverString+parseInt(temp[11]/10)+",";

				//final
				dmxPayloadString="u="+parseInt(globalController.Universe)+"&d="+moverString+"0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0";
				// console.log(dmxPayloadString);
				// dmxPayloadString="u="+parseInt(globalController.Universe)+"&d="+getPixelData()+"0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0";
				xhttp.send(dmxPayloadString);
			}	

			function initializeDMX() {
				xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						console.log("Initialize DMX: "+this.responseText);
						toggleDmxSend();
					}else{
						clearInterval(dmxInterval);
						console.log("DMX Not Available");
					}
				};
				xhttp.open("GET","proxy/reload", true);
				xhttp.send();
			}
		
			function getMoverData(){
				// maxNumDMXScenes=gui.__folders.DMX.__controllers.filter(obj => { return obj.property == "DMX_Scene"})[0].max;
				globalController.DMX_Scene=(globalController.DMX_Scene+globalController.DMX_Preset_Rate)%maxNumDMXScenes;
				//gui.__folders.DMX.__controllers[2].updateDisplay();
				var top=(Math.ceil(globalController.DMX_Scene)%maxNumDMXScenes);
				var bottom=Math.floor(globalController.DMX_Scene);
				fade_Position=globalController.DMX_Scene%1.0;
				if( (fade_Position+globalController.DMX_Fade_Time) > 1.0){
					fade_Position=1.0;
				}else{
					fade_Position=fade_Position+globalController.DMX_Fade_Time;
				}
				// console.log("top:"+top+"  botoom:"+bottom+"  position:"+fade_Position);
				pixelDataString="";
				for(i=0;i<dmxPresetData[Math.floor(globalController.DMX_Scene)].length;i++){
					pixelDataString=pixelDataString+parseInt(parseInt(globalController.Pixel_Level*((dmxPresetData[top][i]*fade_Position) + (dmxPresetData[bottom][i]*(1-fade_Position)))))+",";
				}
				// console.log(pixelDataString);
				return pixelDataString;
			}
		
		</script>
	</body>
</html>

